<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chá de Casa Nova</title>

  <style>
    :root {
      --cinza: #6b696a;
      --verde-claro: #a3b899;
      --fundo: #f5f5f5;
      --branco: #ffffff;
      --bege:  #e8e0d0;
      --madeira:#c8a887;
    }
    body{font-family:"Helvetica Neue",Arial,sans-serif;background:var(--fundo);color:var(--cinza);margin:0;line-height:1.6;}
    .container{max-width:1000px;margin:0 auto;padding:2rem;}
    header{text-align:center;margin-bottom:3rem;}
    h1{font-size:2.5rem;font-weight:300;margin:.5rem 0;}
    .subtitle{font-size:1.2rem;font-weight:300;margin-bottom:2rem;}

    .theme-info{background:var(--bege);border-radius:8px;padding:1.5rem;margin-bottom:2.5rem;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,.05);}
    .theme-title{font-size:1.1rem;font-weight:500;margin-bottom:1rem;}
    .color-palette{display:flex;justify-content:center;gap:1rem;margin:1rem 0;}
    .color-swatch{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .color-swatch span{font-size:.8rem;color:#444;background:rgba(255,255,255,.8);padding:2px 8px;border-radius:10px;}
    .theme-description{font-size:.95rem;max-width:80%;margin:0 auto;color:#555;}

    .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:2rem;}
    .card{background:var(--branco);border-radius:8px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.05);transition:.3s;position:relative;}
    .card:hover{transform:translateY(-5px);box-shadow:0 8px 16px rgba(0,0,0,.1);}
    .card-img{height:180px;background:var(--verde-claro);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;}
    .card-content{padding:1.5rem;position:relative;padding-top:2.5rem;} /* Modificado: padding-top aumentado */
    .card-title{font-size:1.2rem;font-weight:500;margin-bottom:.5rem;transition:text-decoration .3s;}
    .card-title.selected{text-decoration:line-through;color:#777;} /* Modificado: cor mais escura */
    .card-description{font-size:.9rem;color:#888;margin-bottom:1.5rem;}
    .card-footer{display:flex;justify-content:space-between;align-items:center;}
    .btn{display:inline-block;background:var(--cinza);color:#fff;padding:.6rem 1.2rem;border-radius:4px;text-decoration:none;font-size:.9rem;transition:.3s;}
    .btn:hover{background:#555;}
    .checkbox-wrapper{display:flex;align-items:center;gap:.5rem;}
    .custom-checkbox{-webkit-appearance:none;appearance:none;width:20px;height:20px;border:2px solid var(--cinza);border-radius:4px;cursor:pointer;position:relative;transition:.3s;}
    .custom-checkbox:checked{background:var(--verde-claro);border-color:var(--verde-claro);}
    .custom-checkbox:checked::after{content:'✓';color:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
    .checkbox-label{font-size:.8rem;color:#888;}
    .item-status{
      position:absolute;
      top:1.2rem; /* Modificado: de 3.2rem para 1.2rem */
      left:1.5rem;
      font-size:.9rem;
      font-weight:500;
      color:var(--verde-claro);
      display:none;
      background-color:white; /* Adicionado: fundo branco */
      padding:2px 8px; /* Adicionado: padding */
      border-radius:4px; /* Adicionado: cantos arredondados */
      box-shadow:0 1px 3px rgba(0,0,0,0.1); /* Adicionado: sombra suave */
    }
    .item-status.selected{display:block;}

    /* modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:.3s;}
    .modal-overlay.active{opacity:1;visibility:visible;}
    .modal{background:#fff;border-radius:8px;width:90%;max-width:400px;padding:2rem;box-shadow:0 4px 20px rgba(0,0,0,.15);text-align:center;}
    .modal h3{margin:0;color:var(--cinza);font-weight:500;}
    .modal-actions{display:flex;justify-content:center;gap:1rem;margin-top:1.5rem;}
    .modal-btn{padding:.6rem 1.8rem;border-radius:4px;border:none;font-size:.9rem;cursor:pointer;transition:.3s;}
    .confirm-btn{background:var(--verde-claro);color:#fff;}
    .confirm-btn:hover{background:#8fa788;}
    .cancel-btn{background:#eee;color:#666;}
    .cancel-btn:hover{background:#ddd;}

    footer{text-align:center;margin-top:4rem;padding-top:2rem;border-top:1px solid #eee;color:#888;font-size:.9rem;}
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--verde-claro);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    /* Error message */
    .error-message {
      color: #d9534f;
      padding: 1rem;
      margin: 1rem 0;
      border: 1px solid #d9534f;
      border-radius: 4px;
      background-color: #f9f2f4;
      text-align: center;
    }
    
    /* Botão de recarregar */
    .reload-btn {
      background: var(--verde-claro);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Carregando itens...</div>
    <div id="loadingError" style="display: none; margin-top: 20px;">
      <p class="error-message">Erro ao carregar dados. Verifique sua conexão.</p>
      <button class="reload-btn" onclick="window.location.reload()">Tentar novamente</button>
    </div>
  </div>

  <div class="container">
    <!-- ---------- cabeçalho ---------- -->
    <header>
      <h1>Chá de Casa Nova – Luiza &amp; Fellipe</h1>
      <p class="subtitle">Marque o item que você gostaria de levar para nossa nova casa</p>

      <div class="theme-info">
        <div class="theme-title">Paleta de cores da nossa casa</div>
        <div class="color-palette">
          <div class="color-swatch" style="background:#e8e0d0;"><span>Creme</span></div>
          <div class="color-swatch" style="background:#d8cdb5;"><span>Bege</span></div>
          <div class="color-swatch" style="background:#c8a887;"><span>Madeira</span></div>
          <div class="color-swatch" style="background:#b6a284;"><span>Bambu</span></div>
        </div>
        <p class="theme-description">
          Nossa casa terá uma decoração em tons neutros, com elementos em madeira e bambu,
          criando um ambiente acolhedor e natural. Presentes nestas cores combinarão
          perfeitamente com nosso estilo!
        </p>
      </div>
    </header>

    <!-- Mensagem de erro para exibir problemas de Firebase -->
    <div id="mainError" class="error-message" style="display: none;">
      <p>Não foi possível conectar ao banco de dados. Suas escolhas serão salvas localmente.</p>
    </div>

    <!-- ---------- grid de cards ---------- -->
    <div class="card-grid">
      <!-- CARD TEMPLATE – copie/cole alterando id e textos -->
      <!-- 1 -->
      <div class="card">
        <div class="card-img">Panelas</div>
        <div class="card-content">
          <h3 class="card-title">Conjunto de panelas</h3>
          <p class="card-description">Conjunto de panelas para cozinhar no dia a dia.</p>
          <div class="card-footer">
            <div class="checkbox-wrapper" style="margin-left:auto;">
              <input type="checkbox" class="custom-checkbox" id="item1" />
              <label for="item1" class="checkbox-label">Escolher item</label>
            </div>
          </div>
        </div>
      </div>
      <!-- 2 -->
      <div class="card">
        <div class="card-img">Talheres</div>
        <div class="card-content">
          <h3 class="card-title">Talheres</h3>
          <p class="card-description">Facas, garfos, colheres grandes e pequenas e faca de carne.</p>
          <div class="card-footer">
            <div class="checkbox-wrapper" style="margin-left:auto;">
              <input type="checkbox" class="custom-checkbox" id="item2" />
              <label for="item2" class="checkbox-label">Escolher item</label>
            </div>
          </div>
        </div>
      </div>
      <!-- 3 -->
      <div class="card">
        <div class="card-img">Utensílios</div>
        <div class="card-content">
          <h3 class="card-title">Colheres e espátulas</h3>
          <p class="card-description">Colheres e espátulas para cozinhar.</p>
          <div class="card-footer">
            <div class="checkbox-wrapper" style="margin-left:auto;">
              <input type="checkbox" class="custom-checkbox" id="item3" />
              <label for="item3" class="checkbox-label">Escolher item</label>
            </div>
          </div>
        </div>
      </div>
      <!-- 4 -->
      <div class="card">
        <div class="card-img">Café</div>
        <div class="card-content">
          <h3 class="card-title">Prensa francesa</h3>
          <p class="card-description">Para preparar café de forma artesanal.</p>
          <div class="card-footer">
            <div class="checkbox-wrapper" style="margin-left:auto;">
              <input type="checkbox" class="custom-checkbox" id="item4" />
              <label for="item4" class="checkbox-label">Escolher item</label>
            </div>
          </div>
        </div>
      </div>
      <!-- Outros cards... -->
    </div>

    <footer><p>Muito obrigado pelo carinho e presença!</p></footer>
  </div>

  <!-- Modal de confirmação -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <h3>Confirmação</h3>
      <p class="modal-text" id="modalText">Você optou por [item]. Você confirma?</p>
      <div class="modal-actions">
        <button class="modal-btn confirm-btn" id="confirmBtn">Sim</button>
        <button class="modal-btn cancel-btn" id="cancelBtn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- =============== Firebase + JS =============== -->
  <script type="module">
    // Timer de carregamento para timeout
    const loadingTimeout = setTimeout(() => {
      document.getElementById('loadingError').style.display = 'block';
    }, 15000); // 15 segundos para timeout
    
    /* 1 ▸ imports */
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js");
      const { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } = 
        await import("https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js");
    
      // Variáveis para o modo de fallback
      let usingLocalStorage = false;
      const localStorageKey = 'chaCasaNova_escolhas';
      
      // Mostrar loading
      const loadingOverlay = document.getElementById('loadingOverlay');
      const mainError = document.getElementById('mainError');
      
      /* 2 ▸ config */
      const firebaseConfig = {
        apiKey: "AIzaSyBthvOflM2Vge4Q2Sc-kJTQ81OA0Zw7i7I",
        authDomain: "chacasanova-dbc8d.firebaseapp.com",
        projectId: "chacasanova-dbc8d",
        storageBucket: "chacasanova-dbc8d.appspot.com",
        messagingSenderId: "332754318600",
        appId: "1:332754318600:web:22d8ac2c56fc5e52d668bd",
        measurementId: "G-TLP3P8XE8P"
      };
      
      try {
        console.log("Inicializando Firebase...");
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log("Firebase inicializado com sucesso!");
        
        // Tentar inicializar o app com timeout
        const initPromise = inicializarPagina(db).catch(error => {
          console.error("Erro ao inicializar página:", error);
          throw error;
        });
        
        // Adicionar um timeout para não ficar esperando infinitamente
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error("Timeout ao inicializar")), 10000);
        });
        
        await Promise.race([initPromise, timeoutPromise]);
        
        // Se chegou aqui, foi bem-sucedido
        clearTimeout(loadingTimeout);
        loadingOverlay.style.display = 'none';
        
      } catch (error) {
        // Usar localStorage como fallback
        console.error("Erro ao inicializar Firebase:", error);
        clearTimeout(loadingTimeout);
        usingLocalStorage = true;
        
        // Exibir mensagem de erro
        mainError.style.display = 'block';
        loadingOverlay.style.display = 'none';
        
        // Inicializar modo offline
        inicializarModoOffline();
      }
      
      // Função para inicializar modo offline (fallback para localStorage)
      function inicializarModoOffline() {
        console.log("Iniciando em modo offline com localStorage");
        
        // Carregar escolhas salvas no localStorage
        let escolhasLocais = {};
        try {
          const saved = localStorage.getItem(localStorageKey);
          if (saved) {
            escolhasLocais = JSON.parse(saved);
          }
        } catch (e) {
          console.error("Erro ao ler localStorage:", e);
        }
        
        // Configurar checkboxes baseado no localStorage
        document.querySelectorAll(".custom-checkbox").forEach(cb => {
          const id = cb.id;
          const escolhido = !!escolhasLocais[id];
          
          // Aplicar visual
          cb.checked = escolhido;
          updateItemAppearanceOffline(cb, escolhido);
          
          // Adicionar evento de clique
          cb.addEventListener("click", e => {
            e.preventDefault();
            
            if (cb.checked) return; // já escolhido
            
            const titleElement = cb.closest(".card").querySelector(".card-title");
            const name = titleElement ? titleElement.textContent : "item desconhecido";
            
            // Abrir modal
            openModalOffline(cb, name);
          });
        });
        
        // Configurar modal para modo offline
        const modalOverlay = document.getElementById("confirmModal");
        const modalText = document.getElementById("modalText");
        const confirmBtn = document.getElementById("confirmBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        let currentCheckbox = null;
        
        function openModalOffline(cb, name) {
          currentCheckbox = cb;
          modalText.textContent = `Você optou por ${name}. Você confirma?`;
          modalOverlay.classList.add("active");
        }
        
        function closeModalOffline() {
          modalOverlay.classList.remove("active");
          if (currentCheckbox) currentCheckbox.checked = false;
          currentCheckbox = null;
        }
        
        confirmBtn.addEventListener("click", () => {
          if (currentCheckbox) {
            const id = currentCheckbox.id;
            
            // Salvar no localStorage
            escolhasLocais[id] = true;
            localStorage.setItem(localStorageKey, JSON.stringify(escolhasLocais));
            
            // Atualizar UI
            currentCheckbox.checked = true;
            updateItemAppearanceOffline(currentCheckbox, true);
            closeModalOffline();
          }
        });
        
        cancelBtn.addEventListener("click", closeModalOffline);
      }
      
      // Função auxiliar para atualizar aparência no modo offline
      function updateItemAppearanceOffline(cb, selected) {
        const card = cb.closest(".card");
        const title = card.querySelector(".card-title");
        const status = card.querySelector(".item-status") || document.createElement("div");
        
        if (!card.querySelector(".item-status")) {
          status.classList.add("item-status");
          status.textContent = "Item já escolhido";
          card.querySelector(".card-content").appendChild(status);
        }
        
        const wrap = card.querySelector(".checkbox-wrapper");
        
        if (selected) {
          title.classList.add("selected");
          status.classList.add("selected");
          wrap.style.display = "none";
        } else {
          title.classList.remove("selected");
          status.classList.remove("selected");
          wrap.style.display = "flex";
        }
      }

      // Função principal de inicialização com Firebase
      async function inicializarPagina(db) {
        /* 3 ▸ funções de apoio */
        function updateItemAppearance(cb, selected) {
          const card = cb.closest(".card");
          const title = card.querySelector(".card-title");
          const status = card.querySelector(".item-status") || document.createElement("div");
          
          if (!card.querySelector(".item-status")) {
            status.classList.add("item-status");
            status.textContent = "Item já escolhido";
            card.querySelector(".card-content").appendChild(status);
          }
          
          const wrap = card.querySelector(".checkbox-wrapper");
          
          if (selected) {
            title.classList.add("selected");
            status.classList.add("selected");
            wrap.style.display = "none";
          } else {
            title.classList.remove("selected");
            status.classList.remove("selected");
            wrap.style.display = "flex";
          }
        }

        // Função para gravar a escolha no Firestore
        async function gravarEscolha(id) {
          try {
            console.log(`Tentando gravar escolha para item ${id}...`);
            
            // Verifica se o item já está escolhido
            const docRef = doc(db, "presentes", id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists() && docSnap.data().escolhido === true) {
              alert("Este item já foi escolhido por outra pessoa!");
              return false;
            }
            
            // Se não estiver escolhido, grava a escolha
            await setDoc(docRef, { 
              escolhido: true,
              timestamp: new Date().toISOString() 
            });
            console.log(`Item ${id} escolhido com sucesso!`);
            return true;
          } catch (error) {
            console.error(`Erro ao gravar escolha para item ${id}:`, error);
            
            // Se falhar, tentar registrar localmente
            if (!usingLocalStorage) {
              usingLocalStorage = true;
              mainError.style.display = 'block';
              
              try {
                let escolhasLocais = {};
                const saved = localStorage.getItem(localStorageKey);
                if (saved) {
                  escolhasLocais = JSON.parse(saved);
                }
                
                escolhasLocais[id] = true;
                localStorage.setItem(localStorageKey, JSON.stringify(escolhasLocais));
                return true;
              } catch (e) {
                console.error("Erro ao salvar no localStorage:", e);
              }
            }
            
            alert("Ocorreu um erro ao escolher o item. Tente novamente.");
            return false;
          }
        }

        // Mapa de estado local para cada item
        const itemState = new Map();

        // Função para escutar mudanças em tempo real
        function escutarItem(id, cb) {
          console.log(`Configurando listener para item ${id}...`);
          
          // Definir estado inicial como não escolhido
          itemState.set(id, false);
          
          // Testar conexão primeiro
          return onSnapshot(
            doc(db, "presentes", id),
            (snap) => {
              // Verificar se o documento existe E tem a propriedade escolhido como true
              const marcado = snap.exists() && snap.data()?.escolhido === true;
              console.log(`Atualização recebida para item ${id}:`, snap.data(), `Escolhido: ${marcado}`);
              
              // Atualizar o estado local
              itemState.set(id, marcado);
              
              // Atualizar a UI
              cb.checked = marcado;
              updateItemAppearance(cb, marcado);
            },
            (error) => {
              console.error(`Erro ao escutar item ${id}:`, error);
              
              // Se falhar a escuta, pode ser problema de permissões
              if (!usingLocalStorage) {
                usingLocalStorage = true;
                mainError.style.display = 'block';
                inicializarModoOffline();
              }
            }
          );
        }

        /* 4 ▸ lógica da página */
        console.log("Configurando elementos da página...");
        
        /* variáveis do modal */
        const modalOverlay = document.getElementById("confirmModal");
        const modalText = document.getElementById("modalText");
        const confirmBtn = document.getElementById("confirmBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        let currentCheckbox = null;

        if (!modalOverlay || !modalText || !confirmBtn || !cancelBtn) {
          console.error("Elementos do modal não encontrados!");
          throw new Error("Elementos do modal não encontrados");
        }

        /* adiciona status labels aos cards */
        document.querySelectorAll(".card").forEach(card => {
          if (!card.querySelector(".item-status")) {
            const st = document.createElement("div");
            st.classList.add("item-status");
            st.textContent = "Item já escolhido";
            card.querySelector(".card-content").appendChild(st);
          }
        });

        /* funções do modal */
        const openModal = (cb, name) => {
          console.log(`Abrindo modal para item: ${name}`);
          currentCheckbox = cb;
          modalText.textContent = `Você optou por ${name}. Você confirma?`;
          modalOverlay.classList.add("active");
        };
        
        const closeModal = () => {
          console.log("Fechando modal");
          modalOverlay.classList.remove("active");
          if (currentCheckbox) currentCheckbox.checked = false;
          currentCheckbox = null;
        };

        confirmBtn.addEventListener("click", async () => {
          console.log("Botão de confirmar clicado");
          if (currentCheckbox) {
            console.log(`Confirmando escolha do item: ${currentCheckbox.id}`);
            const success = await gravarEscolha(currentCheckbox.id);
            if (success) {
              closeModal();
            }
          }
        });
        
        cancelBtn.addEventListener("click", () => {
          console.log("Botão de cancelar clicado");
          closeModal();
        });

        /* listeners de cada checkbox */
        const checkboxes = document.querySelectorAll(".custom-checkbox");
        console.log(`Encontrados ${checkboxes.length} checkboxes`);
        
        const listeners = [];
        
        // Configurar todos os listeners e esperar até que estejam prontos
        const setupPromises = [];
        
        checkboxes.forEach(cb => {
          // Inicializa o estado de cada item e armazena o listener
          const listenerId = cb.id;
          
          // Adiciona ao array de promessas
          const promise = new Promise(resolve => {
            const unsubscribe = escutarItem(listenerId, cb);
            listeners.push(unsubscribe);
            
            // Aguarda um curto período para garantir que o listener foi configurado
            setTimeout(resolve, 100);
          });
          
          setupPromises.push(promise);
          
          // Adiciona evento de clique
          cb.addEventListener("click", e => {
            console.log(`Checkbox ${cb.id} clicado`);
            e.preventDefault();
            
            // Verifica se o item já está escolhido no estado local
            if (itemState.get(cb.id)) {
              console.log(`Item ${cb.id} já está escolhido, ignorando clique`);
              return;
            }
            
            const titleElement = cb.closest(".card").querySelector(".card-title");
            const name = titleElement ? titleElement.textContent : "item desconhecido";
            console.log(`Usuário clicou para escolher: ${name}`);
            openModal(cb, name);
          });
        });
        
        // Aguardar a configuração de todos os listeners
        await Promise.all(setupPromises);
        
        console.log("Página inicializada com sucesso!");
      }
    } catch (importError) {
      console.error("Erro ao importar módulos do Firebase:", importError);
      document.getElementById('loadingError').style.display = 'block';
      
      // Após 5 segundos, redirecionar para uma versão estática
      setTimeout(() => {
        document.getElementById('loadingOverlay').innerHTML = '<p>Não foi possível carregar o Firebase. Redirecionando para versão simplificada.</p>';
        // Aqui você poderia redirecionar para uma versão sem Firebase
      }, 5000);
    }
  </script>
</body>
</html>
